service: vocali-api

provider:
  name: aws
  runtime: nodejs20.x
  stage: 'dev'
  region: 'us-east-1'
  memorySize: 512
  timeout: 29
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:GetItem
            - dynamodb:Scan
            - dynamodb:DeleteItem
          Resource: 
            - arn:aws:dynamodb:${self:provider.region}:*:table/UsersTable
            - arn:aws:dynamodb:${self:provider.region}:*:table/UsersTable/index/*   
            - arn:aws:dynamodb:${self:provider.region}:*:table/TranscriptionTable
            - arn:aws:dynamodb:${self:provider.region}:*:table/TranscriptionTable/index/*
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:SignUp
            - cognito-idp:ConfirmSignUp
            - cognito-idp:AdminConfirmSignUp
            - cognito-idp:InitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
          Resource: !GetAtt CognitoUserPool.Arn 

functions:
  register:
    handler: app/handlers/register.handler
    description: function to register a user
    events:
      - http:
          path: /register
          method: post
          cors:
            origin: '*' # or '*' for all origins
            headers:
              - Content-Type
              - Authorization
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  login:
    handler: app/handlers/login.handler
    description: function to login a user
    events:
      - http:
          path: /login
          method: post
          cors:
            origin: '*' # or '*' for all origins
            headers:
              - Content-Type
              - Authorization
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  transcribe-file:
    handler: app/handlers/transcribe-file.handler
    description: function to transcribe a file
    events:
      - http:
          path: /transcribe-file
          method: post
          cors:
            origin: '*' 
            headers:
              - Content-Type
              - Authorization
    environment:
      SPEECHMATICS_API_KEY: ${env:SPEECHMATICS_API_KEY}
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  get-transcriptions:
    handler: app/handlers/get-transcriptions.handler
    description: function to get transcriptions
    events:
      - http:
          path: /transcriptions
          method: get
          cors:
            origin: '*' 
            headers:
              - Content-Type
              - Authorization
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  download-transcription:
    handler: app/handlers/download-transcription.handler
    description: function to download a transcription file
    events:
      - http:
          path: /transcriptions/{transcriptionId}/download
          method: get
          cors:
            origin: '*' 
            headers:
              - Content-Type
              - Authorization
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  create-transcription:
    handler: app/handlers/create-transcription.handler
    description: function to create a transcription by raw content
    events:
      - http:
          path: /transcriptions
          method: post
          cors:
            origin: '*' 
            headers:
              - Content-Type
              - Authorization
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient
  speechmatics-token:
    handler: app/handlers/speechmatic-token.handler
    description: function to get speechmatic token
    events:
      - http:
          path: /speechmatics-token
          method: post
          cors:
            origin: '*' 
            headers:
              - Content-Type
              - Authorization
    environment:
      SPEECHMATICS_API_KEY: ${env:SPEECHMATICS_API_KEY}
      USER_POOL_ID: !Ref CognitoUserPool
      CLIENT_ID: !Ref CognitoUserPoolClient

resources:
  Resources:
    UserTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: UsersTable
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
    TranscriptionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: TranscriptionTable
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: vocali-user-pool
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireUppercase: true
            RequireNumbers: true
            RequireSymbols: true
        Schema:
          - Name: email
            AttributeDataType: String
            Mutable: true
            Required: true
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: vocali-app-client
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH

  Outputs:
    UserPoolId:
      Value: !Ref CognitoUserPool
    UserPoolClientId:
      Value: !Ref CognitoUserPoolClient